# OpenTelemetry

CLARA can utilize OpenTelemetry traces as data source for finding components and to some extent component types, as well as communications between components.
For that feature to work correctly, it is crucial to have instrumented applications and an OpenTelemetry Collector running in the cluster as described below.

### Concept
["OpenTelemetry is an Observability framework and toolkit designed to create and manage telemetry data such as traces, metrics, and logs."](https://opentelemetry.io/docs/what-is-opentelemetry/)   
Traces and metrics are generated by each component individually and are forwarded to an OpenTelemetry collector, which processes the telemetry data and distributes it to a backend which utilizes it.  
CLARA can be seen as such a backend, which offers a gRPC endpoint for the oTel-collector to forward the traces to.
CLARA then iterates over the traces and extracts information about components and their communications from that.

### Setup
When using OpenTelemetry for CLARA you first need to ensure your software components are instrumented with OpenTelemetry traces.
If not consider using [OpenTelemetry auto-instrumentation](#opentelemetry-auto-instrumentation).

!!! warning "OpenTelemetry Semantic Conventions"
    Because OpenTelemetry traces' attributes are not standardized, it is recommended to use tracing with the [OpenTelemetry semantic conventions](https://opentelemetry.io/docs/specs/semconv/) for CLARA.
    If your services do not provide them, you can try to set up the [OpenTelemetry auto-instrumentation](#opentelemetry-auto-instrumentation) on top of your system.

Second, ensure that there is an [OpenTelemetry collector](#opentelemetry-collector) with the matching configuration is running in your cluster.
Third, when you use CLARA on a local machine and do not deploy in the cluster, you need to forward the traces from the OpenTelemetry collector to your local machine.
The open-source tool [ktunnel](#ktunnel) can be used to achieve this.

#### OpenTelemetry Collector
The [OpenTelemetry collector](https://opentelemetry.io/docs/collector/) is a default component provided by OpenTelemetry itself.
For CLARA only traces are used, thus the minimal configuration 
The image can be used to deploy a container with a suitable configuration as shown below.
Examples for service and deployment configurations can be found in [clara/deployment/open-telemetry-collector/deployment.yml](https://github.com/SteveBinary/clara/blob/main/deployment/open-telemetry-collector/deployment.yml)

```yaml title="An example ConfigMap for the oTel-collector deployment"
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-conf
  labels:
    app: otel-collector-conf
    component: otel-collector-conf
data:
  otel-collector-conf: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:

    processors:

    exporters:
      otlp:
        endpoint: "localhost:7878"
        tls:
          insecure: true

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: []
          exporters: [otlp]
```

#### ktunnel
[ktunnel](https://github.com/omrikiei/ktunnel/tree/master) is an open-source tool that enables reverse port-forwarding to extract data out of kubernetes clusters.
In order to use CLARA on a local machine, a ktunnel sidecar can be attached towards the OpenTelemetry collector deployment using   
```ktunnel inject deployment otel-collector-deployment 7878 -n <namespace>```  
For further information see the [ktunnel docs](https://github.com/omrikiei/ktunnel/blob/master/README.md). 

#### OpenTelemetry Auto-instrumentation
OpenTelemetry Auto-instrumentation can be used to generate OpenTelemetry traces on software components that are not instrumented themselves in Kubernetes clusters.
This works by applying sidecar containers to each yet to be instrumented service that capture the network traffic and generate traces from that.  
For documentation on installation please see the [official docs from OpenTelemetry](https://opentelemetry.io/docs/kubernetes/operator/automatic/#).

### Aggregation Algorithms
todo

#### Client-Server
todo

#### Producer-Consumer
todo